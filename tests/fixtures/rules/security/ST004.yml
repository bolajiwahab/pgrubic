---
rule: ST004

test_fail_security_definer_function_without_pg_temp_last_element_in_search_path:
  sql_fail: |
    CREATE OR REPLACE FUNCTION security_definer()
    RETURNS TEXT LANGUAGE SQL SECURITY DEFINER SET TIME ZONE 'Europe/Rome'
    SET search_path = admin AS $$ SELECT 1; $$;
  sql_fix: |
    CREATE OR REPLACE FUNCTION security_definer ()
    RETURNS text
    LANGUAGE SQL
    SECURITY DEFINER
    SET TIME ZONE 'Europe/Rome'
    SET search_path TO 'admin'
                     , 'pg_temp'
    AS $BODY$
        SELECT 1;
    $BODY$;

test_fail_security_definer_function_with_pg_temp_not_last_element_in_search_path:
  sql_fail: |
    CREATE OR REPLACE FUNCTION security_definer()
    RETURNS TEXT LANGUAGE SQL SECURITY DEFINER SET TIME ZONE 'Europe/Rome'
    SET search_path = pg_temp, admin AS $$ SELECT 1; $$;
  sql_fix: |
    CREATE OR REPLACE FUNCTION security_definer ()
    RETURNS text
    LANGUAGE SQL
    SECURITY DEFINER
    SET TIME ZONE 'Europe/Rome'
    SET search_path TO 'admin'
                     , 'pg_temp'
    AS $BODY$
        SELECT 1;
    $BODY$;

test_pass_security_definer_function_with_pg_temp_last_element_in_search_path:
  sql_pass: |
    CREATE FUNCTION security_definer()
    RETURNS TEXT LANGUAGE SQL SECURITY DEFINER SET TIME ZONE 'Europe/Rome'
    SET search_path = admin, pg_temp AS $$ SELECT 1; $$;

test_pass_security_definer_function_without_search_path:
  sql_pass: |
    CREATE FUNCTION security_definer()
    RETURNS TEXT LANGUAGE SQL SECURITY DEFINER
    SET TIME ZONE 'Europe/Rome' AS $$ SELECT 1; $$;
